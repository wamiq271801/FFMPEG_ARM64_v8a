name: Build FFmpeg Android ARM64 AAR

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version (latest, n6.1, n7.0, etc.)'
        required: false
        default: 'latest'
      build_type:
        description: 'Build type'
        required: false
        default: 'release'
        type: choice
        options:
        - release
        - debug
  push:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/**'
      - 'build-scripts/**'

env:
  ANDROID_API_LEVEL: 21
  ANDROID_NDK_VERSION: 26.1.10909125
  TARGET_ARCH: arm64-v8a
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'release' }}
  FFMPEG_VERSION: ${{ github.event.inputs.ffmpeg_version || 'latest' }}

jobs:
  build-ffmpeg-android:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    strategy:
      fail-fast: false
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Environment Information
      id: setup-info
      run: |
        echo "build-date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "runner-os=${{ runner.os }}" >> $GITHUB_OUTPUT
        echo "arch=$(uname -m)" >> $GITHUB_OUTPUT
        echo "cores=$(nproc)" >> $GITHUB_OUTPUT
        
    - name: System Information & Cleanup
      run: |
        echo "=== System Information ==="
        uname -a
        echo "Available CPU cores: $(nproc)"
        echo "Available memory: $(free -h)"
        echo "Available disk space:"
        df -h
        
        # Clean up pre-installed packages that might conflict
        echo "=== Cleaning potential conflicts ==="
        sudo apt-get remove -y --purge \
          ffmpeg libavcodec* libavformat* libavutil* libswscale* \
          x264 libx264* opus-tools libopus* \
          2>/dev/null || true
        sudo apt-get autoremove -y
        sudo apt-get autoclean

    - name: Install System Dependencies
      run: |
        echo "=== Installing system dependencies ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          git \
          wget \
          curl \
          unzip \
          autoconf \
          automake \
          libtool \
          nasm \
          yasm \
          python3 \
          python3-pip \
          openjdk-17-jdk \
          ca-certificates \
          gnupg \
          lsb-release
          
        # Install modern build tools
        pip3 install --upgrade pip setuptools wheel

    - name: Setup Android NDK
      id: setup-ndk
      run: |
        echo "=== Setting up Android NDK ${{ env.ANDROID_NDK_VERSION }} ==="
        export NDK_VERSION=${{ env.ANDROID_NDK_VERSION }}
        
        # Download and setup Android NDK
        cd $HOME
        wget -q https://dl.google.com/android/repository/android-ndk-r26c-linux.zip
        unzip -q android-ndk-r26c-linux.zip
        
        export ANDROID_NDK_ROOT=$HOME/android-ndk-r26c
        export ANDROID_NDK=$ANDROID_NDK_ROOT
        
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_NDK=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
        
        # Verify NDK installation
        ls -la $ANDROID_NDK_ROOT
        echo "NDK version: $($ANDROID_NDK_ROOT/ndk-build --version)"

    - name: Setup Build Environment
      id: setup-build
      run: |
        echo "=== Setting up build environment ==="
        
        # Create build directories
        mkdir -p $HOME/ffmpeg-build/{src,build,prefix,logs}
        export BUILD_ROOT=$HOME/ffmpeg-build
        export PREFIX_ROOT=$BUILD_ROOT/prefix
        export SRC_ROOT=$BUILD_ROOT/src
        export BUILD_DIR=$BUILD_ROOT/build
        export LOG_DIR=$BUILD_ROOT/logs
        
        echo "BUILD_ROOT=$BUILD_ROOT" >> $GITHUB_ENV
        echo "PREFIX_ROOT=$PREFIX_ROOT" >> $GITHUB_ENV
        echo "SRC_ROOT=$SRC_ROOT" >> $GITHUB_ENV
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "LOG_DIR=$LOG_DIR" >> $GITHUB_ENV
        
        # Setup Android toolchain variables
        export TARGET_HOST=aarch64-linux-android
        export API=${{ env.ANDROID_API_LEVEL }}
        export AR=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/${TARGET_HOST}${API}-clang
        export AS=$CC
        export CXX=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/${TARGET_HOST}${API}-clang++
        export LD=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/ld
        export RANLIB=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib
        export STRIP=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip
        export NM=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm
        
        echo "TARGET_HOST=$TARGET_HOST" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "CC=$CC" >> $GITHUB_ENV
        echo "AS=$AS" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "RANLIB=$RANLIB" >> $GITHUB_ENV
        echo "STRIP=$STRIP" >> $GITHUB_ENV
        echo "NM=$NM" >> $GITHUB_ENV
        
        # Common flags
        export CFLAGS="-O3 -fPIC -DANDROID -D__ANDROID_API__=${API} -fstack-protector-strong"
        export CXXFLAGS="$CFLAGS -std=c++17"
        export LDFLAGS="-L$PREFIX_ROOT/lib"
        export PKG_CONFIG_PATH="$PREFIX_ROOT/lib/pkgconfig"
        
        echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
        echo "CXXFLAGS=$CXXFLAGS" >> $GITHUB_ENV
        echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Build libx264
      id: build-x264
      run: |
        echo "=== Building libx264 ==="
        cd $SRC_ROOT
        
        # Clone latest x264
        git clone --depth 1 https://code.videolan.org/videolan/x264.git
        cd x264
        
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --cross-prefix=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/${TARGET_HOST}${{ env.ANDROID_API_LEVEL }}- \
          --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
          --extra-cflags="$CFLAGS" \
          --extra-ldflags="$LDFLAGS" \
          --enable-static \
          --enable-pic \
          --disable-shared \
          --disable-cli \
          --disable-asm \
          2>&1 | tee $LOG_DIR/x264-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/x264-build.log
        make install 2>&1 | tee $LOG_DIR/x264-install.log
        
        echo "x264 build completed"

    - name: Build libx265
      id: build-x265
      run: |
        echo "=== Building libx265 ==="
        cd $SRC_ROOT
        
        # Clone latest x265
        git clone --depth 1 https://bitbucket.org/multicoreware/x265_git.git x265
        cd x265/build/linux
        
        # Create Android toolchain file
        cat > android.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Android)
        set(CMAKE_SYSTEM_VERSION 21)
        set(CMAKE_ANDROID_ARCH_ABI arm64-v8a)
        set(CMAKE_ANDROID_NDK $ENV{ANDROID_NDK})
        set(CMAKE_ANDROID_STL_TYPE c++_shared)
        EOF
        
        cmake -DCMAKE_TOOLCHAIN_FILE=android.cmake \
          -DCMAKE_INSTALL_PREFIX=$PREFIX_ROOT \
          -DENABLE_SHARED=OFF \
          -DENABLE_CLI=OFF \
          -DCMAKE_BUILD_TYPE=Release \
          ../../source \
          2>&1 | tee $LOG_DIR/x265-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/x265-build.log
        make install 2>&1 | tee $LOG_DIR/x265-install.log
        
        echo "x265 build completed"

    - name: Build libopus
      id: build-opus
      run: |
        echo "=== Building libopus ==="
        cd $SRC_ROOT
        
        # Clone latest opus
        git clone --depth 1 https://github.com/xiph/opus.git
        cd opus
        
        ./autogen.sh
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --disable-shared \
          --enable-static \
          --disable-doc \
          --disable-extra-programs \
          --enable-float-approx \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          2>&1 | tee $LOG_DIR/opus-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/opus-build.log
        make install 2>&1 | tee $LOG_DIR/opus-install.log
        
        echo "opus build completed"

    - name: Build libvpx
      id: build-vpx
      run: |
        echo "=== Building libvpx ==="
        cd $SRC_ROOT
        
        # Clone latest libvpx
        git clone --depth 1 https://chromium.googlesource.com/webm/libvpx.git
        cd libvpx
        
        ./configure \
          --prefix=$PREFIX_ROOT \
          --target=arm64-android-gcc \
          --sdk-path=$ANDROID_NDK \
          --disable-examples \
          --disable-unit-tests \
          --enable-vp8 \
          --enable-vp9 \
          --enable-pic \
          --disable-shared \
          --as=yasm \
          --extra-cflags="$CFLAGS" \
          --extra-cxxflags="$CXXFLAGS" \
          2>&1 | tee $LOG_DIR/vpx-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/vpx-build.log
        make install 2>&1 | tee $LOG_DIR/vpx-install.log
        
        echo "libvpx build completed"

    - name: Build dav1d (AV1 Decoder)
      id: build-dav1d
      run: |
        echo "=== Building dav1d ==="
        cd $SRC_ROOT
        
        # Clone latest dav1d (fast AV1 decoder)
        git clone --depth 1 https://code.videolan.org/videolan/dav1d.git
        cd dav1d
        
        # Install meson for building
        pip3 install meson ninja
        
        # Create cross file for Android
        cat > android-cross.txt << EOF
        [binaries]
        c = '$CC'
        cpp = '$CXX'
        ar = '$AR'
        strip = '$STRIP'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'android'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        
        [properties]
        c_args = ['$CFLAGS']
        cpp_args = ['$CXXFLAGS']
        c_link_args = ['$LDFLAGS']
        cpp_link_args = ['$LDFLAGS']
        EOF
        
        meson setup build \
          --cross-file android-cross.txt \
          --prefix=$PREFIX_ROOT \
          --default-library=static \
          --buildtype=release \
          -Denable_tools=false \
          -Denable_tests=false \
          2>&1 | tee $LOG_DIR/dav1d-configure.log
          
        ninja -C build 2>&1 | tee $LOG_DIR/dav1d-build.log
        ninja -C build install 2>&1 | tee $LOG_DIR/dav1d-install.log
        
        echo "dav1d build completed"

    - name: Build libaom (AV1 Encoder/Decoder)
      id: build-aom
      run: |
        echo "=== Building libaom ==="
        cd $SRC_ROOT
        
        # Clone latest aom
        git clone --depth 1 https://aomedia.googlesource.com/aom
        cd aom
        
        mkdir build && cd build
        
        cmake -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_NATIVE_API_LEVEL=${{ env.ANDROID_API_LEVEL }} \
          -DCMAKE_INSTALL_PREFIX=$PREFIX_ROOT \
          -DBUILD_SHARED_LIBS=OFF \
          -DENABLE_DOCS=OFF \
          -DENABLE_EXAMPLES=OFF \
          -DENABLE_TESTDATA=OFF \
          -DENABLE_TESTS=OFF \
          -DENABLE_TOOLS=OFF \
          -DCONFIG_RUNTIME_CPU_DETECT=0 \
          -DCMAKE_BUILD_TYPE=Release \
          .. \
          2>&1 | tee $LOG_DIR/aom-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/aom-build.log
        make install 2>&1 | tee $LOG_DIR/aom-install.log
        
        echo "aom build completed"

    - name: Build libfdk-aac
      id: build-fdk-aac
      run: |
        echo "=== Building libfdk-aac ==="
        cd $SRC_ROOT
        
        # Clone latest fdk-aac
        git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
        cd fdk-aac
        
        ./autogen.sh
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --disable-shared \
          --enable-static \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          2>&1 | tee $LOG_DIR/fdk-aac-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/fdk-aac-build.log
        make install 2>&1 | tee $LOG_DIR/fdk-aac-install.log
        
        echo "fdk-aac build completed"

    - name: Build libmp3lame
      id: build-lame
      run: |
        echo "=== Building libmp3lame ==="
        cd $SRC_ROOT
        
        # Download latest lame source
        wget -q https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz
        tar xzf lame-3.100.tar.gz
        cd lame-3.100
        
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --disable-shared \
          --enable-static \
          --disable-frontend \
          --enable-nasm \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          2>&1 | tee $LOG_DIR/lame-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/lame-build.log
        make install 2>&1 | tee $LOG_DIR/lame-install.log
        
        echo "libmp3lame build completed"

    - name: Build libvorbis
      id: build-vorbis
      run: |
        echo "=== Building libvorbis ==="
        cd $SRC_ROOT
        
        # First build libogg (dependency)
        git clone --depth 1 https://github.com/xiph/ogg.git
        cd ogg
        ./autogen.sh
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --disable-shared \
          --enable-static \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          2>&1 | tee $LOG_DIR/ogg-configure.log
        make -j$(nproc) && make install
        
        # Now build libvorbis
        cd $SRC_ROOT
        git clone --depth 1 https://github.com/xiph/vorbis.git
        cd vorbis
        ./autogen.sh
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --disable-shared \
          --enable-static \
          --disable-docs \
          --disable-examples \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          2>&1 | tee $LOG_DIR/vorbis-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/vorbis-build.log
        make install 2>&1 | tee $LOG_DIR/vorbis-install.log
        
        echo "vorbis build completed"

    - name: Build libwebp
      id: build-webp
      run: |
        echo "=== Building libwebp ==="
        cd $SRC_ROOT
        
        # Clone latest libwebp
        git clone --depth 1 https://chromium.googlesource.com/webm/libwebp.git
        cd libwebp
        
        ./autogen.sh
        ./configure \
          --prefix=$PREFIX_ROOT \
          --host=$TARGET_HOST \
          --disable-shared \
          --enable-static \
          --enable-libwebpmux \
          --enable-libwebpdemux \
          --enable-libwebpdecoder \
          --disable-gl \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          2>&1 | tee $LOG_DIR/webp-configure.log
          
        make -j$(nproc) 2>&1 | tee $LOG_DIR/webp-build.log
        make install 2>&1 | tee $LOG_DIR/webp-install.log
        
        echo "webp build completed"

    - name: Clone FFmpeg Official Repository
      id: clone-ffmpeg
      run: |
        echo "=== Cloning FFmpeg official repository ==="
        cd $SRC_ROOT
        
        if [ "${{ env.FFMPEG_VERSION }}" == "latest" ]; then
          git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git
        else
          git clone --depth 1 --branch ${{ env.FFMPEG_VERSION }} https://git.ffmpeg.org/ffmpeg.git
        fi
        
        cd ffmpeg
        echo "FFmpeg version: $(git describe --tags 2>/dev/null || echo 'master')"
        
        # Store FFmpeg version info
        FFMPEG_HASH=$(git rev-parse HEAD)
        echo "FFMPEG_HASH=$FFMPEG_HASH" >> $GITHUB_ENV

    - name: Configure FFmpeg
      id: configure-ffmpeg
      run: |
        echo "=== Configuring FFmpeg ==="
        cd $SRC_ROOT/ffmpeg
        
        # Build configure arguments step by step
        CONFIGURE_ARGS=""
        CONFIGURE_ARGS="$CONFIGURE_ARGS --prefix=$PREFIX_ROOT"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-cross-compile"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --target-os=android"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --arch=aarch64"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --cpu=cortex-a53"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --cross-prefix=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --extra-cflags=$CFLAGS"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --extra-ldflags=$LDFLAGS"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --extra-libs=-L$PREFIX_ROOT/lib"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --pkg-config-flags=--static"
        
        # Enable static libraries and disable shared
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-static --disable-shared"
        
        # Enable external libraries (without OpenSSL)
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libx264"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libx265"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libopus"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libvpx"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libmp3lame"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libfdk-aac"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libvorbis"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libwebp"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libaom"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-libdav1d"
        
        # Enable useful codecs and formats for Android
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libx264"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libx265"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libopus"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libvpx_vp8"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libvpx_vp9"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libmp3lame"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libfdk_aac"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libvorbis"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libwebp"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=libaom_av1"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=aac"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-encoder=h264_mediacodec"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-decoder=h264_mediacodec"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-decoder=libdav1d"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-decoder=libaom_av1"
        
        # Enable basic protocols (without SSL/HTTPS)
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-protocol=file"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-protocol=http"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-protocol=tcp"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-protocol=udp"
        
        # Enable useful formats for streaming/mobile
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-demuxer=mov"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-demuxer=mp4"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-demuxer=matroska"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-demuxer=webm"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-muxer=mp4"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-muxer=matroska"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-muxer=webm"
        
        # Disable unnecessary components to reduce size
        CONFIGURE_ARGS="$CONFIGURE_ARGS --disable-programs"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --disable-doc"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --disable-debug"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --disable-avdevice"
        CONFIGURE_ARGS="$CONFIGURE_ARGS --disable-postproc"
        
        # First try without GPL to avoid license conflicts
        echo "=== Attempting configure without GPL ==="
        eval "./configure $CONFIGURE_ARGS" 2>&1 | tee $LOG_DIR/ffmpeg-configure-first.log
        
        if [ $? -ne 0 ]; then
          echo "=== First configure failed, trying with GPL ==="
          # If that fails, try with GPL (user must accept licensing)
          CONFIGURE_ARGS="$CONFIGURE_ARGS --enable-gpl"
          eval "./configure $CONFIGURE_ARGS" 2>&1 | tee $LOG_DIR/ffmpeg-configure-gpl.log
          
          if [ $? -ne 0 ]; then
            echo "=== GPL configure also failed, trying minimal build ==="
            # Last resort: minimal build
            ./configure \
              --prefix=$PREFIX_ROOT \
              --enable-cross-compile \
              --target-os=android \
              --arch=aarch64 \
              --cross-prefix=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}- \
              --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
              --extra-cflags="$CFLAGS" \
              --extra-ldflags="$LDFLAGS" \
              --enable-static \
              --disable-shared \
              --disable-programs \
              --disable-doc \
              2>&1 | tee $LOG_DIR/ffmpeg-configure-minimal.log
          fi
        fi
        
        echo "FFmpeg configuration completed"

    - name: Build FFmpeg
      id: build-ffmpeg
      run: |
        echo "=== Building FFmpeg ==="
        cd $SRC_ROOT/ffmpeg
        
        make clean 2>/dev/null || true
        make -j$(nproc) 2>&1 | tee $LOG_DIR/ffmpeg-build.log
        
        if [ $? -ne 0 ]; then
          echo "=== Build failed, checking logs ==="
          tail -50 $LOG_DIR/ffmpeg-build.log
          exit 1
        fi
        
        make install 2>&1 | tee $LOG_DIR/ffmpeg-install.log
        echo "FFmpeg build completed successfully"

    - name: Create Android AAR Structure
      id: create-aar
      run: |
        echo "=== Creating Android AAR structure ==="
        
        # Create AAR directory structure
        mkdir -p $BUILD_DIR/aar/{jni/arm64-v8a,res,assets}
        mkdir -p $BUILD_DIR/aar/META-INF
        
        # Copy built libraries
        cp $PREFIX_ROOT/lib/*.a $BUILD_DIR/aar/jni/arm64-v8a/ 2>/dev/null || true
        cp $PREFIX_ROOT/lib/*.so $BUILD_DIR/aar/jni/arm64-v8a/ 2>/dev/null || true
        
        # Create AndroidManifest.xml for AAR
        cat > $BUILD_DIR/aar/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.ffmpeg.android"
            android:versionCode="1"
            android:versionName="1.0">
            
            <uses-sdk android:minSdkVersion="21" android:targetSdkVersion="34" />
        </manifest>
        EOF

        # Create classes.jar (empty but required for AAR)
        mkdir -p $BUILD_DIR/temp/classes
        echo "public class FFmpegNative {}" > $BUILD_DIR/temp/classes/FFmpegNative.java
        javac -d $BUILD_DIR/temp/classes $BUILD_DIR/temp/classes/FFmpegNative.java
        jar cf $BUILD_DIR/aar/classes.jar -C $BUILD_DIR/temp/classes .
        
        # Create R.txt (empty but required)
        touch $BUILD_DIR/aar/R.txt
        
        # List what we have
        echo "=== AAR Contents ==="
        find $BUILD_DIR/aar -type f -exec ls -la {} \;

    - name: Package AAR
      id: package-aar
      run: |
        echo "=== Packaging AAR ==="
        cd $BUILD_DIR/aar
        
        # Create the AAR file
        AAR_NAME="ffmpeg-android-arm64-$(date +%Y%m%d-%H%M%S).aar"
        zip -r "../$AAR_NAME" . 2>&1 | tee $LOG_DIR/aar-package.log
        
        echo "AAR_NAME=$AAR_NAME" >> $GITHUB_ENV
        echo "AAR_PATH=$BUILD_DIR/$AAR_NAME" >> $GITHUB_ENV
        
        # Verify AAR
        echo "=== AAR Verification ==="
        unzip -l "../$AAR_NAME"
        ls -la "../$AAR_NAME"

    - name: Build Summary and Issue Analysis
      id: build-summary
      run: |
        echo "=== Build Summary ==="
        
        BUILD_SUCCESS=true
        ISSUES_FOUND=""
        
        # Check if AAR was created successfully
        if [ ! -f "$AAR_PATH" ]; then
          BUILD_SUCCESS=false
          ISSUES_FOUND="$ISSUES_FOUND\n- AAR file was not created"
        fi
        
        # Check for libraries in AAR
        if [ -f "$AAR_PATH" ]; then
          LIB_COUNT=$(unzip -l "$AAR_PATH" | grep "jni/arm64-v8a/.*\.a$" | wc -l)
          if [ $LIB_COUNT -eq 0 ]; then
            ISSUES_FOUND="$ISSUES_FOUND\n- No static libraries found in AAR"
          fi
        fi
        
        # Analyze build logs for common issues
        if [ -f "$LOG_DIR/ffmpeg-build.log" ]; then
          if grep -q "error:" "$LOG_DIR/ffmpeg-build.log"; then
            BUILD_SUCCESS=false
            ISSUES_FOUND="$ISSUES_FOUND\n- FFmpeg build errors detected"
            echo "=== FFmpeg Build Errors ==="
            grep "error:" "$LOG_DIR/ffmpeg-build.log" | head -10
          fi
          
          if grep -q "undefined reference" "$LOG_DIR/ffmpeg-build.log"; then
            BUILD_SUCCESS=false
            ISSUES_FOUND="$ISSUES_FOUND\n- Undefined references (linking issues)"
          fi
          
          if grep -q "license" "$LOG_DIR/ffmpeg-build.log"; then
            echo "=== License-related messages found ==="
            grep -i "license" "$LOG_DIR/ffmpeg-build.log"
          fi
        fi
        
        # Generate build summary
        echo "=== Generating Build Summary ===" 
        echo "# FFmpeg Android Build Summary" > $BUILD_DIR/build-summary.md
        echo "" >> $BUILD_DIR/build-summary.md
        echo "**Build Date:** ${{ steps.setup-info.outputs.build-date }}" >> $BUILD_DIR/build-summary.md
        echo "**Target Architecture:** ${{ env.TARGET_ARCH }}" >> $BUILD_DIR/build-summary.md
        echo "**Android API Level:** ${{ env.ANDROID_API_LEVEL }}" >> $BUILD_DIR/build-summary.md
        echo "**FFmpeg Version:** ${{ env.FFMPEG_VERSION }}" >> $BUILD_DIR/build-summary.md
        echo "**FFmpeg Commit:** ${{ env.FFMPEG_HASH }}" >> $BUILD_DIR/build-summary.md
        echo "**Build Type:** ${{ env.BUILD_TYPE }}" >> $BUILD_DIR/build-summary.md
        
        if [ "$BUILD_SUCCESS" = true ]; then
          echo "**Build Status:** ‚úÖ SUCCESS" >> $BUILD_DIR/build-summary.md
        else
          echo "**Build Status:** ‚ùå FAILED" >> $BUILD_DIR/build-summary.md
        fi
        
        echo "" >> $BUILD_DIR/build-summary.md
        echo "## External Libraries Built" >> $BUILD_DIR/build-summary.md
        echo "### Modern Video Codecs:" >> $BUILD_DIR/build-summary.md
        echo "- libx264 (H.264 video encoding - industry standard)" >> $BUILD_DIR/build-summary.md
        echo "- libx265 (H.265/HEVC video encoding - next-gen compression)" >> $BUILD_DIR/build-summary.md
        echo "- libvpx (VP8/VP9 video codecs - web optimized)" >> $BUILD_DIR/build-summary.md
        echo "- libaom (AV1 encoder - future-proof codec)" >> $BUILD_DIR/build-summary.md
        echo "- libdav1d (AV1 decoder - fast and efficient)" >> $BUILD_DIR/build-summary.md
        echo "- libwebp (WebP image format - modern web images)" >> $BUILD_DIR/build-summary.md
        echo "" >> $BUILD_DIR/build-summary.md
        echo "### Modern Audio Codecs:" >> $BUILD_DIR/build-summary.md
        echo "- libopus (Opus audio codec - low latency, high quality)" >> $BUILD_DIR/build-summary.md
        echo "- libfdk-aac (High-quality AAC encoder)" >> $BUILD_DIR/build-summary.md
        echo "- libvorbis (Vorbis audio codec - open source)" >> $BUILD_DIR/build-summary.md
        echo "- libmp3lame (MP3 encoding - compatibility)" >> $BUILD_DIR/build-summary.md
        echo "" >> $BUILD_DIR/build-summary.md
        echo "### Network Support (No SSL):" >> $BUILD_DIR/build-summary.md
        echo "- HTTP protocols enabled (no HTTPS due to disabled OpenSSL)" >> $BUILD_DIR/build-summary.md
        echo "- TCP/UDP streaming protocols" >> $BUILD_DIR/build-summary.md
        echo "" >> $BUILD_DIR/build-summary.md
        echo "### Hardware Acceleration:" >> $BUILD_DIR/build-summary.md
        echo "- Android MediaCodec integration" >> $BUILD_DIR/build-summary.md
        echo "- Hardware H.264/H.265 decode acceleration" >> $BUILD_DIR/build-summary.md
        echo "- Hardware VP8/VP9 decode acceleration" >> $BUILD_DIR/build-summary.md
        echo "" >> $BUILD_DIR/build-summary.md
        echo "## AAR Information" >> $BUILD_DIR/build-summary.md
        echo "- **File:** $AAR_NAME" >> $BUILD_DIR/build-summary.md
        
        if [ -f "$AAR_PATH" ]; then
          AAR_SIZE=$(ls -lh "$AAR_PATH" | awk '{print $5}')
          echo "- **Size:** $AAR_SIZE" >> $BUILD_DIR/build-summary.md
        else
          echo "- **Size:** N/A" >> $BUILD_DIR/build-summary.md
        fi
        
        echo "- **Target ABI:** arm64-v8a only" >> $BUILD_DIR/build-summary.md
        echo "" >> $BUILD_DIR/build-summary.md
        echo "## Issues Found" >> $BUILD_DIR/build-summary.md
        
        if [ -n "$ISSUES_FOUND" ]; then
          echo -e "$ISSUES_FOUND" >> $BUILD_DIR/build-summary.md
        else
          echo "No issues detected" >> $BUILD_DIR/build-summary.md
        fi
        
        echo "BUILD_SUCCESS=$BUILD_SUCCESS" >> $GITHUB_ENV
        cat $BUILD_DIR/build-summary.md

    - name: Upload AAR Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-android-arm64-aar
        path: |
          ${{ env.AAR_PATH }}
          ${{ env.BUILD_DIR }}/build-summary.md
          ${{ env.LOG_DIR }}/*.log
        retention-days: 30

    - name: Upload Build Logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-build-logs-failed
        path: |
          ${{ env.LOG_DIR }}/*.log
          ${{ env.BUILD_DIR }}/build-summary.md
        retention-days: 7

    - name: Final Status Report
      run: |
        echo "=== Final Build Status ==="
        if [ "$BUILD_SUCCESS" = true ]; then
          echo "‚úÖ Build completed successfully!"
          echo "üì¶ AAR file: $AAR_NAME"
          echo "üéØ Target: Android ARM64 (arm64-v8a)"
          echo "üìè API Level: ${{ env.ANDROID_API_LEVEL }}"
        else
          echo "‚ùå Build failed with issues"
          echo "üìã Check the build summary and logs for details"
          exit 1
        fi
